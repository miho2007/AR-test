<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>AR.js + VR Hybrid (Stable Feed)</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.7/aframe/build/aframe-ar.js"></script>
    <style>
      html, body { margin:0; width:100%; height:100%; overflow:hidden; background:black; }
      #cameraFeed {
        position:absolute;
        top:0; left:0;
        width:100%; height:100%;
        object-fit:cover;
        z-index:0;
        background:black;
      }
      a-scene {
        position:absolute;
        top:0; left:0;
        width:100%; height:100%;
        z-index:1;
      }
    </style>
  </head>
  <body>
    <!-- Manual webcam feed -->
    <video id="cameraFeed" autoplay playsinline muted></video>

    <!-- AR.js Scene -->
    <a-scene
      vr-mode-ui="enabled: true"
      embedded
      renderer="antialias: true; alpha: true; precision: mediump;"
      arjs="trackingMethod: best; sourceType: video; debugUIEnabled: false;"
    >
      <a-marker preset="hiro">
        <a-box position="0 0.5 0" rotation="0 45 0" color="blue"></a-box>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      const video = document.getElementById('cameraFeed');
      let arSourceReady = false;

      // Start webcam manually
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
          video.srcObject = stream;
          video.play();

          // Attach the feed to AR.js manually
          const arScene = document.querySelector('a-scene');
          arScene.addEventListener('loaded', () => {
            const arSystem = arScene.systems["arjs"];
            if (arSystem && arSystem.arToolkitSource) {
              arSystem.arToolkitSource.domElement = video;
              arSystem.arToolkitSource.ready = true;
              console.log("✅ AR.js video source attached manually.");
            }
          });
        })
        .catch(err => console.error("Camera error:", err));

      // Enable XR / VR after AR.js ready
      const scene = document.querySelector('a-scene');
      scene.addEventListener('loaded', () => {
        if (scene.renderer && scene.renderer.xr) {
          scene.renderer.xr.enabled = true;
          console.log("✅ WebXR ready (AR + VR hybrid).");
        }
      });
    </script>
  </body>
</html>
