<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stable AR.js + VR Camera Feed</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.7/aframe/build/aframe-ar.js"></script>
  <style>
    html, body { margin:0; padding:0; overflow:hidden; width:100%; height:100%; background:black; }
  </style>
</head>
<body>
  <video id="cameraFeed" autoplay playsinline muted style="display:none"></video>

  <a-scene
    embedded
    renderer="antialias: true; alpha: true;"
    arjs="trackingMethod: best; sourceType: video; debugUIEnabled: false;"
    vr-mode-ui="enabled: true"
  >
    <!-- Background plane with our manual camera feed -->
    <a-assets>
      <video id="videoTexture" autoplay playsinline muted></video>
    </a-assets>

    <a-entity id="background"
              geometry="primitive: plane; height: 2; width: 2"
              material="shader: flat; src: #videoTexture"
              position="0 0 -1">
    </a-entity>

    <!-- AR marker -->
    <a-marker preset="hiro">
      <a-box position="0 0.5 0" rotation="0 45 0" color="red"></a-box>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const videoFeed = document.getElementById('cameraFeed');
    const textureVideo = document.getElementById('videoTexture');

    // 🧠 Step 1: Request the camera manually
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(stream => {
        console.log("✅ Camera stream acquired");
        videoFeed.srcObject = stream;
        textureVideo.srcObject = stream;
        return new Promise(res => {
          textureVideo.onloadedmetadata = () => {
            textureVideo.play();
            res();
          };
        });
      })
      .then(() => {
        // 🧩 Step 2: Replace AR.js internal source with our manual feed
        const arSystem = document.querySelector('a-scene').systems['arjs'];
        if (arSystem && arSystem.arToolkitSource) {
          arSystem.arToolkitSource.domElement = videoFeed; // override
          arSystem.arToolkitSource.ready = true;
          console.log("🔁 Replaced AR.js video source with manual stream");
        }

        // Fit background plane aspect ratio
        const aspect = textureVideo.videoWidth / textureVideo.videoHeight;
        document.getElementById('background').setAttribute('geometry', {
          primitive: 'plane',
          height: 2,
          width: 2 * aspect
        });
      })
      .catch(err => console.error("🚫 Camera access error:", err));
  </script>
</body>
</html>
